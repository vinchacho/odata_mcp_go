# v1.6.0 Major Features Design

**Status**: Implemented
**Author**: Claude + Vincent
**Date**: 2025-12-14
**Target Version**: v1.6.0

---

## Overview

v1.6.0 is a major feature release that adds security enhancements, reliability improvements, new transports, and fine-grained control over tool generation.

---

## Feature 1: Credential Masking in Verbose Output

### Problem Statement

When `--verbose` is enabled, sensitive credentials can appear in logs:
- Passwords in URLs or headers
- CSRF tokens
- Authorization header values
- Cookie values

This creates security risks when sharing debug logs.

### Solution

Add a dedicated masking module that sanitizes sensitive data before logging:

```go
// internal/debug/masking.go
func MaskPassword(s string) string       // Returns "***"
func MaskCSRFToken(s string) string      // Returns "****<last8>"
func MaskAuthHeader(s string) string     // Returns "Basic ****"
func MaskURL(u string) string            // Masks userinfo and sensitive params
func MaskCookie(s string) string         // Returns "****"
```

### Files Changed

| File | Changes |
|------|---------|
| `internal/debug/masking.go` | NEW - Masking utility functions |
| `internal/client/client.go` | Use masking in verbose output |

### Acceptance Criteria

- [ ] Passwords completely masked as `***`
- [ ] CSRF tokens show only last 8 characters
- [ ] Authorization headers show type but mask credentials
- [ ] URLs mask passwords in userinfo
- [ ] Cookie values masked in debug output

---

## Feature 2: Exponential Backoff Retry with Jitter

### Problem Statement

Transient network failures and rate limits cause immediate request failures. SAP services can be flaky under load.

### Solution

Implement configurable retry logic with exponential backoff and jitter:

```
Retry Logic:
1. On retryable error (429, 500, 502, 503, 504)
2. Wait: initial_backoff * (multiplier ^ attempt) ± 10% jitter
3. Retry up to max_attempts
4. CSRF refresh doesn't count toward retry limit
```

### CLI Interface

```bash
--retry-max-attempts 3           # Max retry attempts
--retry-initial-backoff-ms 100   # Initial backoff (ms)
--retry-max-backoff-ms 10000     # Max backoff cap (ms)
--retry-backoff-multiplier 2.0   # Multiplier per attempt
```

### Files Changed

| File | Changes |
|------|---------|
| `internal/config/config.go` | Add retry config fields |
| `cmd/odata-mcp/main.go` | Add CLI flags |
| `internal/client/client.go` | Implement retry logic |

### Acceptance Criteria

- [ ] Retries on 429, 500, 502, 503, 504
- [ ] Exponential backoff with configurable multiplier
- [ ] Random jitter (±10%) prevents thundering herd
- [ ] Context cancellation respected during backoff
- [ ] CSRF refresh separate from retry count

---

## Feature 3: Streamable HTTP Transport

### Problem Statement

The stdio transport only works for local processes. HTTP/SSE transport is needed for remote access, but the MCP protocol has evolved to support streamable HTTP.

### Solution

Add a new transport type (`--transport streamable-http`) that implements the modern MCP protocol:

```
Architecture:
┌──────────────────────────────────────────────────────┐
│                STREAMABLE HTTP TRANSPORT              │
├──────────────────────────────────────────────────────┤
│                                                      │
│  Single endpoint: /mcp                               │
│                                                      │
│  Request flow:                                       │
│    POST /mcp → JSON-RPC request                      │
│         ↓                                            │
│    Response: JSON-RPC response OR                    │
│              Upgrade to SSE for streaming            │
│                                                      │
│  Features:                                           │
│    • Bidirectional communication                     │
│    • Session management (Last-Event-ID)             │
│    • Auto SSE upgrade for streaming                  │
│    • Backward compat with legacy SSE                 │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### Files Changed

| File | Changes |
|------|---------|
| `internal/transport/streamable.go` | NEW - Streamable HTTP implementation |
| `cmd/odata-mcp/main.go` | Add transport option |

### Acceptance Criteria

- [ ] Single `/mcp` endpoint for all operations
- [ ] Automatic SSE upgrade for streaming responses
- [ ] Session management with Last-Event-ID
- [ ] Protocol version 2024-11-05 support
- [ ] Backward compatibility with legacy SSE

---

## Feature 4: Operation Type Filtering

### Problem Statement

Large OData services generate hundreds of tools (entities × operations). Users often need only read operations or want to exclude specific operation types.

### Solution

Add `--enable` and `--disable` flags for fine-grained operation control:

```
Operation Codes:
  C = Create
  S = Search (full-text)
  F = Filter (list/query)
  G = Get (single entity)
  U = Update
  D = Delete
  A = Actions (function imports)
  R = Read (expands to S, F, G)
```

### CLI Interface

```bash
# Disable create, update, delete
--disable "cud"

# Enable only read operations
--enable "r"

# Disable actions/function imports
--disable "a"
```

### Files Changed

| File | Changes |
|------|---------|
| `internal/config/config.go` | Add enable/disable fields |
| `cmd/odata-mcp/main.go` | Add CLI flags |
| `internal/bridge/bridge.go` | Filter tools based on operation codes |

### Acceptance Criteria

- [ ] Support all operation codes (C, S, F, G, U, D, A, R)
- [ ] R expands to S, F, G
- [ ] Case-insensitive operation codes
- [ ] Mutual exclusion validation (can't enable and disable same)
- [ ] Reduces tool count significantly

---

## Feature 5: Read-Only Modes

### Problem Statement

Production environments need safety guarantees. Users want to expose data without risk of modifications.

### Solution

Add two read-only modes:

| Mode | Flag | Behavior |
|------|------|----------|
| Read-Only | `--read-only` / `-ro` | Hide all mutating operations |
| Read-Only But Functions | `--read-only-but-functions` / `-robf` | Allow function imports |

### Files Changed

| File | Changes |
|------|---------|
| `internal/config/config.go` | Add read-only config fields |
| `cmd/odata-mcp/main.go` | Add CLI flags |
| `internal/bridge/bridge.go` | Filter tools based on mode |

### Acceptance Criteria

- [ ] `--read-only` hides create, update, delete
- [ ] `--read-only-but-functions` allows function imports
- [ ] Works with lazy mode
- [ ] Clear error messages if user tries disabled operation

---

## Feature 6: Flexible Hint System

### Problem Statement

SAP OData services have known quirks (HTTP 501 for unimplemented methods, etc.). Users need service-specific guidance that AI can understand.

### Solution

JSON-based hint configuration with wildcard pattern matching:

```json
{
  "pattern": "*SRA020_PO_TRACKING_SRV*",
  "service_type": "SAP Purchase Order Tracking Service",
  "known_issues": ["Backend doesn't implement GET_ENTITYSET"],
  "workarounds": ["Use $expand to bypass unimplemented methods"]
}
```

### CLI Interface

```bash
# Load hint file
--hints-file ./my-hints.json

# Direct CLI hint
--hint "known_issues=Service requires $expand"
```

### Files Changed

| File | Changes |
|------|---------|
| `internal/hint/hint.go` | NEW - Hint loading and matching |
| `internal/config/config.go` | Add hint config fields |
| `cmd/odata-mcp/main.go` | Add CLI flags |
| `hints.json` | Default SAP hints |

### Acceptance Criteria

- [ ] Wildcard pattern matching
- [ ] Priority-based hint merging
- [ ] Default hints for SAP services
- [ ] Hints appear in `odata_service_info` response

---

## Feature 7: Full MCP Protocol Compliance

### Problem Statement

Claude Desktop and other clients fail with Zod validation errors due to missing handlers and capability declarations.

### Solution

Add missing protocol handlers and proper capability declarations:

```go
// Missing handlers
HandleResourcesList()  // Return empty list
HandlePromptsList()    // Return empty list

// Initialize response capabilities
{
  "capabilities": {
    "tools": { "listChanged": false },
    "resources": { "subscribe": false, "listChanged": false },
    "prompts": { "listChanged": false }
  }
}
```

### Files Changed

| File | Changes |
|------|---------|
| `internal/mcp/server.go` | Add handlers, fix capabilities |

### Acceptance Criteria

- [ ] `resources/list` handler returns empty list
- [ ] `prompts/list` handler returns empty list
- [ ] Initialize includes all capabilities
- [ ] Claude Desktop connects without errors

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Retry causes cascading failures | Low | Medium | Cap max backoff, respect context cancellation |
| Streamable HTTP breaks clients | Low | High | Keep legacy SSE endpoint, document migration |
| Operation filtering confusing | Medium | Low | Clear documentation, validation errors |
| Hints match wrong services | Low | Low | Priority-based matching, specific patterns first |

---

## Success Metrics

| Metric | Target |
|--------|--------|
| No credential leaks in verbose output | 100% |
| Retry reduces transient failures | >80% |
| Claude Desktop compatibility | 100% |
| Tool count reduction with filters | >50% |
