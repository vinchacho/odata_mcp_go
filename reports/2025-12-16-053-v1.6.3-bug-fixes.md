# v1.6.3 Bug Fixes - Implementation Report

**Date:** 2025-12-16
**Report ID:** 053
**Category:** Implementation Report
**Status:** Complete

## Summary

Critical bug fix release addressing race conditions, panic scenarios, and edge cases discovered in production use.

## Bugs Fixed

### 1. Race Condition in ODataClient

**Problem:** Concurrent access to CSRF tokens, session cookies, and cookie map caused data races.

**Solution:** Added mutex guards for all shared state access.

**Files:** `internal/client/client.go`

```go
type ODataClient struct {
    mu          sync.RWMutex  // Guards concurrent access
    csrfToken   string
    cookies     map[string]string
    // ...
}
```

### 2. Multiple EDMX Schema Handling

**Problem:** Parser only processed the first `<Schema>` block, missing entities in multi-schema services.

**Solution:** Iterate over all schema blocks in EDMX document.

**Files:** `internal/metadata/parser.go`

### 3. SSE Accept Header Validation

**Problem:** Rejected combined Accept headers like `text/event-stream, application/json`.

**Solution:** Relaxed header parsing to accept combined types.

**Files:** `internal/transport/http/sse.go`

### 4. Metadata Parse Failure Propagation

**Problem:** Parse failures silently fell back to empty metadata, causing confusing "no tools" scenarios.

**Solution:** Return meaningful error messages with parse failure details.

**Files:** `internal/metadata/parser.go`, `internal/bridge/bridge.go`

### 5. Double-Close Panic in Streamable Transport

**Problem:** Stream done channel could be closed multiple times, causing panic.

**Solution:** Use `sync.Once` to ensure single close.

**Files:** `internal/transport/streamable/streamable.go`

```go
type Stream struct {
    closeOnce sync.Once
    done      chan struct{}
}

func (s *Stream) Close() {
    s.closeOnce.Do(func() {
        close(s.done)
    })
}
```

### 6. Context Propagation in MCP Server

**Problem:** Tool handlers didn't receive HTTP request context, preventing proper cancellation.

**Solution:** Propagate request context through handler chain.

**Files:** `internal/mcp/server.go`

### 7. Concurrent ResponseWriter Writes

**Problem:** SSE message writes and ping keepalives could race.

**Solution:** Added mutex guard for all ResponseWriter access.

**Files:** `internal/transport/http/sse.go`

### 8. Composite Key Ordering

**Problem:** Composite key URL predicates generated in non-deterministic order.

**Solution:** Sort key names alphabetically before building URL.

**Files:** `internal/bridge/bridge.go`

```go
// Before: Products(CategoryID=1,ProductID=2) OR Products(ProductID=2,CategoryID=1)
// After:  Products(CategoryID=1,ProductID=2) (always)
```

## Other Fixes

| Issue | Fix |
|-------|-----|
| Deprecated `io/ioutil` | Replaced with `io` package |
| JSON marshal error swallowed | Now properly logged |
| Constant defaults misaligned | Aligned CLI and code defaults |
| Unreliable mock in tests | Replaced with `httptest.Server` |

## Metrics

| Metric | Value |
|--------|-------|
| Race Conditions Fixed | 3 |
| Panic Scenarios Fixed | 1 |
| Edge Cases Fixed | 5 |
| Test Improvements | 2 |

## Testing Notes

Race conditions were identified using:
```bash
go test -race ./...
```

All fixes include regression tests to prevent recurrence.
