# v1.6.5 HTTP Timeouts & SSE Improvements - Implementation Report

**Date:** 2025-12-17
**Report ID:** 054
**Category:** Implementation Report
**Status:** Complete

## Summary

Added configurable HTTP timeouts for large SAP services and improved SSE observability with dropped message tracking.

## Features Implemented

### 1. HTTP Timeout Configuration

New CLI flags for timeout control:

```bash
--http-timeout 30          # HTTP request timeout (seconds)
--metadata-timeout 60      # Metadata fetch timeout (seconds)
```

**Environment Variables:**
- `ODATA_HTTP_TIMEOUT`
- `ODATA_METADATA_TIMEOUT`

**Rationale:**
Large SAP services can have metadata documents exceeding 10MB, requiring extended fetch times. Separate timeout for metadata allows normal requests to fail fast while accommodating slow metadata loads.

**Files:** `internal/config/config.go`, `internal/client/client.go`

### 2. SSE Dropped Message Logging

When `--verbose` is enabled, SSE transport logs dropped messages:

```
[VERBOSE] SSE: Message dropped for client (buffer full)
```

**Implementation:**
- Atomic counter tracks total dropped messages
- Per-client buffer overflow detection
- Graceful degradation (drops message, doesn't block)

**Files:** `internal/transport/http/sse.go`

```go
type SSEClient struct {
    messages      chan []byte
    droppedCount  atomic.Int64
}

func (c *SSEClient) Send(msg []byte) bool {
    select {
    case c.messages <- msg:
        return true
    default:
        c.droppedCount.Add(1)
        verbose.Log("SSE: Message dropped for client (buffer full)")
        return false
    }
}
```

### 3. Retry Configuration Fix

**Bug:** `--retry-*` CLI flags were defined but never wired to the HTTP client.

**Fix:** Properly apply retry configuration during bridge initialization.

**Files:** `cmd/odata-mcp/main.go`, `internal/client/client.go`

### 4. Linting Configuration

Added `.golangci.yml` with conservative linters:
- `errcheck` - Unchecked errors
- `govet` - Go vet checks
- `staticcheck` - Static analysis
- `unused` - Unused code

## Metrics

| Metric | Value |
|--------|-------|
| New CLI Flags | 2 |
| Bug Fixes | 1 |
| New Features | 2 |

## Usage Example

```bash
# Large SAP service with extended metadata timeout
./odata-mcp \
  --url https://sap.example.com/sap/opu/odata/sap/API_BUSINESS_PARTNER \
  --metadata-timeout 120 \
  --http-timeout 30 \
  --verbose
```

## Notes

The metadata timeout defaults to 60 seconds because:
1. SAP Gateway services often have large metadata (~5-15MB)
2. First metadata fetch includes schema compilation on server
3. Network latency to on-premise SAP systems
4. Users reported timeouts with default 30s on large services
